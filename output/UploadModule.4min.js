UploadModule.debug=true;UploadModule.FileSupported=function(){try{return typeof File!="undefined"}catch(a){return false}};UploadModule.getAuthInfo=function(){var a=$.cookie("Login");var b=$.cookie("Password");var c="";if(a&&a.length>0&&a!='""'&&b&&b.length>0&&b!='""'){c+="&cuid="+a+"&cupa="+b}return c};UploadModule.dropFilesAvailable=function(){if($.browser.msie||$.browser.opera){return false}if(typeof URL=="undefined"||typeof URL.createObjectURL!="function"||typeof FileReader=="undefined"||typeof FileReader.prototype.readAsBinaryString!="function"){return false}else{return true}};UploadModule.XhrUploadSupported=function(){try{return typeof(new XMLHttpRequest()).upload!="undefined"}catch(a){return false}};UploadModule.canUploadDirectory=function(){try{return $.browser.webkit&&!!("webkitdirectory" in document.createElement("input"))}catch(a){return false}};UploadModule.assignUIID=function(b){if(!UploadModule._uploadModuleFileViewId){UploadModule._uploadModuleFileViewId=1}for(var a in b){if(!b[a]._uiFileId){b[a]._uiFileId=UploadModule._uploadModuleFileViewId++}b[a]._loaded=0}return b};UploadModule.assignUploadDir=function(c,b){for(var a in c){if(c[a]._uploadDir===undefined){if(b===undefined){c[a]._uploadDir=UploadModule.getCurrentDirIdForUpload()}else{c[a]._uploadDir=b}}}return c};UploadModule.getNextFolderId=function(){if(!UploadModule._uploadModuleFolderViewId){UploadModule._uploadModuleFolderViewId=1}return ++UploadModule._uploadModuleFolderViewId};UploadModule.getCurrentDirIdForUpload=function(){if(typeof currentDirId=="undefined"){return}return currentDirId};UploadModule.checkSize=function(b,a){return UploadModule.getFileSize(b)<a.max_file_size};UploadModule.checkSizeForCPUArch=function(a){var b=Utils.getCpuArch();var c=2*1024*1024*1024-1024;var d=4*1024*1024*1024-1024;if($.browser.mozilla){return UploadModule.getFileSize(a)<c}else{return((b==32&&UploadModule.getFileSize(a)<c)||(b==64&&UploadModule.getFileSize(a)<d))}};UploadModule.skipRetryIfNeed=function(c,b,a){if(!c._countRetry){c._countRetry=1}else{if(c._countRetry>=a.retryCount){c._countRetry=0;return $.extend({},b,{canRecover:false,needRetry:false})}else{c._countRetry++}}return b};UploadModule.getFileSize=function(a){if(a.size===undefined&&a._data){a.size=a._data.length}return a.size};UploadModule.getFileName=function(a){return a.fileName?a.fileName:a.name};UploadModule.getFilesSize=function(c){var b=0;for(var a=0;a<c.length;a++){b+=UploadModule.getFileSize(c[a])}return b};UploadModule.parseFolderHierarchy=function(f){var d=[];for(var c=0;c<f.length;c++){if(f[c].tempLocalDirId){continue}var g=a(f[c]);f[c].tempLocalDirId=e(g,d)}return d;function e(l,k){var h=k;for(var j=0;j<l.length;j++){h=b(l[j],h);if(j<l.length-1){h=h.childrens}}return h.folderLocalId}function b(j,h){var l=null;for(var k=0;k<h.length&&l==null;k++){if(h[k].folderName==j){l=h[k]}}if(l==null){l={folderLocalId:UploadModule.getNextFolderId(),folderName:j,childrens:[]};h.push(l)}return l}function a(j){if(!j.webkitRelativePath){return[]}var h=j.webkitRelativePath.split(/[\\/]/);h.splice(h.length-1);var k=h.indexOf("");if(k>-1){h.splice(k,1)}return h}};UploadModule.removeFoldersFromDroppedFiles=function(c,e){if(typeof URL=="undefined"||typeof URL.createObjectURL!="function"||typeof FileReader=="undefined"||typeof FileReader.prototype.readAsBinaryString!="function"){e(c);return}var d=Utils.convertToPlainArray(c);var a=[];b(d,a);function b(k,g){if(!k.length){e(g);return}var h=k.shift();if(h.size&&h.size>100000){g.push(h);b(k,g);return}try{var f=new FileReader();f.onerror=function(l){b(k,g);return};f.onload=function(m){var l=URL.createObjectURL(h);var n=new XMLHttpRequest();n.onerror=function(o){URL.revokeObjectURL(l);b(k,g);return};n.onload=function(o){URL.revokeObjectURL(l);g.push(h);b(k,g);return};n.open("GET",l,true);n.send()};f.readAsDataURL(h)}catch(j){b(k,g);return}}};UploadModule.createFolderHierarchy=function(e){var b={currentFolder:e.currentFolder,hierarchy:e.hierarchy,files:e.files,successCallback:e.successCallback,errorCallback:e.errorCallback?e.errorCallback:function(){},onFoldersCreated:e.onFoldersCreated||function(){},checkFolderExists:!!e.checkFolderExists};if(b.checkFolderExists){var d=[];for(var c=0;c<b.hierarchy.length;c++){d.push(b.hierarchy[c].folderName)}g(d,b.files,f)}else{for(var c in b.files){b.files[c]._skipExisting=true}f()}function f(){var j={};j.currentFolder=b.currentFolder;j.folderStructure=b.hierarchy;$.ajax({type:"POST",url:"/web/myAccount/createFolderHierarchical",contentType:"application/json",dataType:"json",data:JSON.stringify(j),success:a,error:function(n){var l=n.responseText;var k=null;if(l){try{k=JSON.parse(l)}catch(m){}}b.errorCallback(k)}})}function a(j){for(var k=0;k<b.files.length;k++){b.files[k]._uploadDir=j.localToServerFoldersIdsMapping[b.files[k].tempLocalDirId]}b.onFoldersCreated();b.successCallback(b.files)}function g(k,m,n){var l="";for(var j=0;j<k.length;j++){l+="&path="+k[j]}$.ajax({type:"get",url:"/rest/sharedFileUpload/checkDirExists?dirId="+b.currentFolder+l,success:function(o){if(o){h(function(p){if(p){for(var q in m){m[q]._skipExisting=p.skipExisting}n()}else{b.errorCallback()}})}else{n()}},error:b.errorCallback})}function h(l){var k=$("#uploadFolderExistsDialog");var j=PopupModule.popup({title:$(".jsUploadFolderExistsPopupTitle",k).val(),content:k.html()});$(".jsSkip",j).click(function(){l({skipExisting:true});j.closePopup()});$(".jsDoNotSkip",j).click(function(){l({skipExisting:false});j.closePopup()});$(".jsClose",j).click(function(){l(false)})}};UploadModule.getNewUploadUrl=function(a,b){$.ajax({type:"post",url:"/rest/sharedFileUpload/newUploadUrl",data:{fileId:a._fileId},success:function(c){a._newDcPath=c.newDcPath;b(true)},error:function(d,e,c){b(false)}})};UploadModule.removeFoldersByDotInName=function(c){var b=[];for(var a=0;a<c.length;a++){if(c[a].name!="."){b.push(c[a])}}return b};UploadModule.ProgressMeterComet=function(b){var a=false;this.start=function(d,c){a=true;c=c||"";Jsonp({url:b.dc_path+b.upload_form_handler.progress_meter_comet+c+"&"+Math.random(),jsonp:function(e){if(!a){return}if(!e.total){return}if(typeof d=="function"){d(e);return}b.onProgress(e)}})};this.stop=function(){a=false};return this};UploadModule.ProgressMeterJson=function(b){var a=false;this.start=function(e,d){a=true;function c(){$.ajax({url:b.dc_path+b.upload_form_handler.progress_meter_json+d+"&"+Math.random(),method:"get",dataType:"json",xhrFields:{withCredentials:true},crossDomain:true,success:function(f){e({files:f})},complete:function(){if(a){setTimeout(c,1000)}}})}c()};this.stop=function(){a=false};return this};UploadModule.HandlerUploadForm=function(f){var v=this;var w=false;var x=(($.browser.msie&&Utils.checkCORSAvailable())||($.browser.opera&&("withCredentials" in new XMLHttpRequest())));var o=(x?new UploadModule.ProgressMeterJson(f):new UploadModule.ProgressMeterComet(f));var k=[];var z=Math.random();var q=0;var b=[];var c;var h=false;var j=null;var a=[];$.each($("input:file"),function(){$(this).replaceWith($(this).removeAttr("multiple").clone(true))});if(!$("#HandlerUploadFormContainer").length){$(document.body).append('<div id="HandlerUploadFormContainer"></div>')}var g=$("#HandlerUploadFormContainer");if(!$("#GetSizeFormsContainer").length){$(document.body).append('<div id="GetSizeFormsContainer"></div>')}var u=$("#GetSizeFormsContainer");function r(D,C){function A(K){if(!j||!j.started){return}var J=null;var G=null;try{J=$(K).contents()}catch(H){G=f.uploadErrors.dc_error}if(J){if($.trim($(J).text())=="blank"){return}if($("#alert",J).val()){var I=$("#errorCode",J).val();G=f.getErrorByErrorCode(I)}else{if($("#uploadedFileId",J).val()){j._fileId=$("#uploadedFileId",J).val();j._d1link=$("#fileUploadUrl",J).val();j._previewLink=$("#previewUrl",J).val();j._isUploaded=true;h=true}}}else{G=f.uploadErrors.dc_error}y(j,G)}function F(H){if(H._newDcPath){f.dc_path=H._newDcPath}var G=f.dc_path+f.url;var I=G+(G.indexOf("?")==-1?"?":"&")+"isForm=true&sessionUploadId="+z+"&fileUploadId="+H._uiFileId;if(H._uploadDir){I+="&x-upload-dir="+H._uploadDir}if(H._updateKeepName){I+="&keepName="+H._updateKeepName}if(H._updateFileId){I+="&updateFileId="+H._updateFileId}return I}var B=D._uiFileId;var E=c?c:f.upload_form;$(g).append($('<form id="uploadForm_'+B+'" class="uploadForm_all"></form>').attr("action",F(D)).attr("target","uploadIFrame_"+B).attr("enctype","multipart/form-data").attr("encoding","multipart/form-data").attr("method","post").append($("input:not(:file)",E).clone(true)).append(C).hide());$(g).append($('<iframe id="uploadIFrame_'+B+'" src="/blankframe.jsp" name="uploadIFrame_'+B+'" class="uploadIFrame_all"></iframe>').load(function(){A(this)}).hide())}function n(B){if(j&&j._uiFileId==B){return j}for(var A in k){if(k[A]._uiFileId==B){return k[A]}}}function d(A){var B=null;if(A.length&&A[0].files&&A[0].files[0]&&A[0].files[0].size){B=A[0].files[0]}else{B={};var C=A.val().split("\\");B.name=C[C.length-1]}B=UploadModule.assignUIID([B])[0];B=UploadModule.assignUploadDir([B],f.toDirId)[0];B._fileInput=A;return B}function p(D,B,G){var F=Math.random();if(D._newDcPath){f.dc_path=D._newDcPath}var C=(x?f.dc_path:"")+f.upload_form_handler.file_size_url+"?sessionUploadId="+F;var A=D._uiFileId;$(u).append($('<form id="getSizeForm_'+A+'"></form>').attr("action",C).attr("target","sizeIFrame_"+A).attr("enctype","multipart/form-data").attr("encoding","multipart/form-data").attr("method","post").append(B).hide());$(u).append($('<iframe name="sizeIFrame_'+A+'" class="sizeIFrame_all"></iframe>').hide());$("#getSizeForm_"+A,u).submit();$.ajax({url:C+"&"+Math.random(),method:"get",dataType:"json",xhrFields:{withCredentials:true},crossDomain:x,success:function(H){Utils.stopFrame($("#sizeIFrame_"+A,u),true);$("#getSizeForm_"+A).remove();if(!H.success){E();return}D.size=H.size;G(D,B,null,true)},error:function(){Utils.stopFrame($("#sizeIFrame_"+A,u),true);$("#getSizeForm_"+A).remove();E()}});function E(){var H=false;Utils.checkConnectionAvaliable(function(I){H=!I},true);f.onAddFiles([D]);if(H){a.push(D);f.onFileError(D,f.uploadErrors.connection_error_scratch)}else{f.onFileError(D,f.uploadErrors.file_too_large_for_browser)}if(!w){f.onCleanup()}}}function l(){o.start(B,"?sessionUploadId="+z);function B(C){if(!C.files){return}for(var H in C.files){var E=C.files[H];var D=n(E.fileId);if(!D){continue}b[E.fileId]=E.uploaded;var G=A();var F={id:E.fileId,fileLoaded:E.uploaded,fileSize:D.size,loaded:G,total:q};f.onProgress(F)}}function A(){var C=0;for(var D in b){C+=b[D]}return C}}function m(){w=true;f.onStart();l();s()}function s(){if(!k.length){t()}else{j=k.shift();UploadModule.currentUploadSessionInfo.addToTotalAndValidateFreeSpace(j,function(){e(j)},function(A){y(j,A)})}}function e(A){r(A,A._fileInput);$("#uploadForm_"+A._uiFileId,g).submit();A.started=true}function y(C,A){A=UploadModule.skipRetryIfNeed(C,A,f);for(var B=0;B<k.length;B++){if(k[B]==C){k.splice(B,1)}}if(A){if(A.errorId==f.uploadErrors.can_not_upload_empty_file.errorId&&C.size){A=f.uploadErrors.file_was_removed}f.onFileError(C,A);if(A.needRetry){o.stop()}}if(!C._isUploaded){if(!A||!A.needRetry){if(C.size){q-=C.size}delete b[C._uiFileId];UploadModule.currentUploadSessionInfo.subtractFromTotal(C)}if(!A){f.onFileCanceled(C);C._isCanceled=true}}else{f.onFileUploaded(C)}if(j==C){$("#uploadForm_"+C._uiFileId+", #uploadIFrame_"+C._uiFileId,g).filter("iframe").attr("src","").end().remove();C.started=false;if(!A||!A.needRetry){s()}}}function t(){w=false;j=null;k=[];q=0;b=[];o.stop();$("iframe",g).attr("src","");$(g).html("");f.onCleanup()}this.start=function(B){var A=B?B:f.upload_form;if(!$(":file[value!=]",A).length){alert(f.i18n.no_files_selected);return false}$(":file[value!=]",A).each(function(C){v.add(null,this)})};this.update=function(A){if(!c){c=A.parents("form:first")}var B={};B._updateKeepName=$("input[name=keepName]",c).val();B._updateFileId=$("input[name=updateFileId]",c).val();v.add(null,A,B)};this.add=function(C,B,D,A){if(!A){B=$(B);if(!C||!C._uiFileId){C=d(B)}$(B).replaceWith($(B).clone(true).val(""));if(D){$.extend(C,D)}if(!C.size){p(C,B,v.add);return}}f.onAddFiles([C]);if(f.required_extensions&&f.required_extensions.length&&$.inArray(Utils.extractExtension(C.name),f.required_extensions)==-1){f.onFileError(C,f.uploadErrors.wrong_file_type)}else{if(UploadModule.getFileSize(C)===undefined){f.onFileError(C,f.uploadErrors.can_not_get_size)}else{if(UploadModule.getFileSize(C)==0){f.onFileError(C,f.uploadErrors.can_not_upload_empty_file)}else{if(!UploadModule.checkSize(C,f)){f.onFileError(C,f.uploadErrors.file_too_large)}else{if(!UploadModule.checkSizeForCPUArch(C)){f.onFileError(C,f.uploadErrors.file_too_large_for_browser)}else{k.push(C);q+=C.size}}}}}if(!w){m()}};this.cancelFile=function(B){if(!w){return}var A=n(B);if(!A){return}y(A)};this.cancel=function(){if(j){f.onFileCanceled(j);j._isCanceled=true}for(var A=0;A<k.length;A++){if(!k[A]._isUploaded){f.onFileCanceled(k[A]);k[A]._isCanceled=true}}t()};this.isUploadInProgress=function(){return w};this.retry=function(A){if(j&&j._uiFileId==A){f.onFileRetry(j);UploadModule.getNewUploadUrl(j,function(C){if(C){f.dc_path=j._newDcPath;l();e(j)}else{y(j,f.uploadErrors.dc_error)}})}else{for(var B=0;B<a.length;B++){if(a[B]._uiFileId==A){v.add(a[B],a[B]._fileInput);a.splice(B,1);break}}}};this.removeFromScratchRetry=function(A){for(var B=0;B<a.length;B++){if(a[B]._uiFileId==A){a.splice(B,1);break}}};return this};UploadModule.HandlerUploadFlash=function(m){var h=this;var c=null;var a=false;var b=[];var j=m.url+(m.url.indexOf("?")==-1?"?":"&")+"isFlash=true&rnd=rnd"+UploadModule.getAuthInfo();var g=new plupload.Uploader({runtimes:"flash",container:"flashContainer",browse_button:"flashFileSelect",max_file_size:Math.floor(m.max_file_size/1024/1024)+"mb",multipart:true,multi_selection:true,url:j,flash_swf_url:"/js/plupload/plupload.flash.swf?rnd"+Math.random()});$("#"+m.flash_select_files_id).wrap($("<div id='flashContainer'></div>").attr("class",$("#"+m.flash_select_files_id).attr("class"))).removeAttr("class");g.bind("FilesAdded",function(n,o,p){Events.fireEvent("hide.context.menus");if(p){return}h.add(o.slice(0));o.splice(0,o.length)});g.bind("QueueChanged",function(n){if(g.state!=plupload.STARTED&&n.files.length){setTimeout(function(){g.start()},100)}});g.bind("BeforeUpload",function(n,o){if(o._newDcPath){m.dc_path=o._newDcPath}n.settings.url=m.dc_path+j+"&x-upload-dir="+o._uploadDir});g.bind("UploadProgress",function(n,o){var p={id:o._uiFileId,fileLoaded:o.loaded,fileSize:o.size};m.onProgress(p)});g.bind("FileUploaded",function(n,q,p){var t=$("<div>"+p.response+"</div>");if(t.find("#uploadedFileId")&&t.find("#uploadedFileId").val()){var r=t.find("#sizeOk");q._d1link=t.find("#fileUploadUrl").val();q._previewLink=t.find("#previewUrl",t).val();q._fileId=t.find("#uploadedFileId").val();q._isUploaded=true;d(q)}else{if(t.find("#alert")&&t.find("#alert").val()){var s=$("#errorCode",t).val();var o=m.getErrorByErrorCode(s);o=o||m.uploadErrors.dc_error;d(q,o)}}});g.bind("Error",function(n,o){var p=g.files[0];if(o.code==-300){d(p,m.uploadErrors.flash_error)}else{d(p,m.uploadErrors.dc_error)}});g.init();g.refresh();function e(){a=true;m.onStart();k()}function k(){if(!b.length){f()}else{c=b.shift();UploadModule.currentUploadSessionInfo.addToTotalAndValidateFreeSpace(c,function(){l(c)},function(n){d(c,n)})}}function d(p,n){n=UploadModule.skipRetryIfNeed(p,n,m);for(var o=0;o<b.length;o++){if(b[o]==p){b.splice(o,1);break}}if(n&&(n.canRecover||n.needRetry)){n=$.extend(n,{canRecover:false,needRetry:false})}if(n){if(n.errorId==m.uploadErrors.can_not_upload_empty_file.errorId&&p.size){n=m.uploadErrors.file_was_removed}m.onFileError(p,n)}if(!p._isUploaded){if(!n||!n.needRetry){UploadModule.currentUploadSessionInfo.subtractFromTotal(p)}if(!n){m.onFileCanceled(p);p._isCanceled=true}}else{m.onFileUploaded(p)}if(p==c){if((!n||!n.needRetry)){g.splice(0,g.files.length);k()}}}function f(){a=false;b=[];c=null;m.onCleanup()}function l(n){n=[n];g.trigger("FilesAdded",n,true)}this.add=function(o){var q=Utils.convertToPlainArray(o);if(!q.length){return}q=UploadModule.assignUIID(q);q=UploadModule.assignUploadDir(q,m.toDirId);m.onAddFiles(q);var p=q;q=[];for(var n=0;n<p.length;n++){if(m.required_extensions&&m.required_extensions.length&&$.inArray(Utils.extractExtension(p[n].name),m.required_extensions)==-1){m.onFileError(p[n],m.uploadErrors.wrong_file_type);continue}if(UploadModule.getFileSize(p[n])==0){m.onFileError(p[n],m.uploadErrors.can_not_upload_empty_file);continue}if(!UploadModule.checkSize(p[n],m)){m.onFileError(p[n],m.uploadErrors.file_too_large);continue}if(!UploadModule.checkSizeForCPUArch(p[n])){m.onFileError(p[n],m.uploadErrors.file_too_large_for_browser);continue}q.push(p[n])}b=b.concat(q);if(!a){e()}};this.cancelFile=function(n){if(c&&c._uiFileId==n&&g.state!=plupload.STARTED){d(c);return}for(var o=0;o<b.length;o++){if(b[o]._uiFileId==n){d(b[o]);return}}};this.cancel=function(){var o=b;b=[];for(var n=0;n<o.length;n++){if(!o[n]._isUploaded){m.onFileCanceled(o[n]);o[n]._isCanceled=true}}if(c&&g.state!=plupload.STARTED){m.onFileCanceled(c);c._isCanceled=true}if(g.state!=plupload.STARTED){f()}};this.retry=function(n){if(c&&c._uiFileId==n){m.onFileRetry(c);UploadModule.getNewUploadUrl(c,function(o){if(o){g.start()}else{d(c,m.uploadErrors.dc_error)}})}};this.isUploadInProgress=function(){return a}};UploadModule.HandlerUploadXhr=function(q){var k=this;var p;var a=false;var c=[];var n=0;var e=0;var l=0;var d=null;var b=q.url.replace("upload.jsp","upload5.jsp");if($.browser.safari){$.each($("input:file"),function(){$(this).replaceWith($(this).removeAttr("multiple").clone(true))})}if(XMLHttpRequest&&!("sendAsBinary" in XMLHttpRequest.prototype)){XMLHttpRequest.prototype.sendAsBinary=function(u){var t=new ArrayBuffer(u.length);var r=new Uint8Array(t,0);for(var s=0;s<u.length;s++){r[s]=(u.charCodeAt(s)&255)}this.send(t)}}function h(s){if(d&&d._uiFileId==s){return d}for(var r in c){if(c[r]._uiFileId==s){return c[r]}}}function o(u){p=new XMLHttpRequest();p._currentFile=u;p.upload.onprogress=v;p.onreadystatechange=s;var t=u._updateKeepName;var r=u._updateFileId;if(u._newDcPath){q.dc_path=u._newDcPath}var x=q.dc_path+b+(b.indexOf("?")==-1?"?":"&")+"isAjax=true&sendHttpStatus=true";x+=UploadModule.getAuthInfo();p.open("POST",x+"&keepName="+t+(u._data?"&base64":"")+(u._data?"&content-length="+u._data.length:"")+(r?"&updateFileId="+r:""),true);if(u._uploadDir){p.setRequestHeader("x-upload-dir",u._uploadDir)}p.setRequestHeader("x-file-name",encodeURIComponent(u.fileName?u.fileName:u.name));p.setRequestHeader("Content-Type","application/octet-stream");if(u._data){p.sendAsBinary(u._data)}else{p.send(u)}function v(z){if(!a){return}if(!z.lengthComputable){return}l=z.loaded;var y={id:p._currentFile._uiFileId,fileLoaded:z.loaded,fileSize:UploadModule.getFileSize(p._currentFile),loaded:(e+z.loaded),total:n};q.onProgress(y)}function w(C){var A=p._currentFile;var z=null;if(p.status==0){z=q.uploadErrors.connection_error}else{if(p.responseText){var y=null;try{y=$.parseJSON(p.responseText)}catch(C){}if(y){var B=y.errorCode;if(B){z=q.getErrorByErrorCode(B)}}}}if(!z){z=q.uploadErrors.dc_error}f(A,z)}function s(B){if(!p){return}var z=p._currentFile;if(!a||z._isUploaded||z._isCanceled){return}var A=false;if(p.readyState==4){if(p.status==200){var y=null;try{y=$.parseJSON(p.responseText)}catch(B){}if(y&&y.status=="OK"){p._currentFile._fileId=y.uploadedFileId;p._currentFile._d1link=y.fileUploadUrl;p._currentFile._previewLink=y.previewUrl;e+=p._currentFile.size;p._currentFile._isUploaded=true;f(p._currentFile)}else{A=true}}else{A=true}}if(A){w(B)}}}function g(){a=true;e=0;l=0;q.onStart();m()}function m(){if(!c.length){j()}else{d=c.shift();UploadModule.currentUploadSessionInfo.addToTotalAndValidateFreeSpace(d,function(){o(d)},function(r){f(d,r)})}}function f(t,r){r=UploadModule.skipRetryIfNeed(t,r,q);for(var s=0;s<c.length;s++){if(c[s]==t){c.splice(s,1);break}}if(r){if(r.errorId==q.uploadErrors.can_not_upload_empty_file.errorId&&t.size){r=q.uploadErrors.file_was_removed}q.onFileError(t,r)}if(!t._isUploaded){if(!r||!r.needRetry){n-=UploadModule.getFileSize(t);UploadModule.currentUploadSessionInfo.subtractFromTotal(t)}if(!r){q.onFileCanceled(t);t._isCanceled=true}}else{q.onProgress({id:t._uiFileId,fileLoaded:UploadModule.getFileSize(t),fileSize:UploadModule.getFileSize(t),loaded:e,total:n});q.onFileUploaded(t)}if(t==d){if(p&&p.readyState!=4){p.abort()}if(!r||!r.needRetry){m()}}}function j(){a=false;if(p){p.abort();p=null}c=[];n=0;e=0;l=0;d=null;q.onCleanup()}this.start=function(){var r=[];if(!$(":file[value!=]",q.upload_form).length){alert(q.i18n.no_files_selected);return false}$("input[type=file]",q.upload_form).each(function(){for(var s=0;s<this.files.length;s++){r.push(this.files[s])}});k.add(r)};this.add=function(u,r,t){var x=Utils.convertToPlainArray(u);Utils.clearInput(r);x=UploadModule.removeFoldersByDotInName(x);x=UploadModule.assignUIID(x);x=UploadModule.assignUploadDir(x,(t!==undefined&&t.toDirId!==undefined)?t.toDirId:q.toDirId);q.onAddFiles(x);if(!x.length){return}var v=x;x=[];for(var s=0;s<v.length;s++){if(q.required_extensions&&q.required_extensions.length&&$.inArray(Utils.extractExtension(v[s].name),q.required_extensions)==-1){q.onFileError(v[s],q.uploadErrors.wrong_file_type);continue}if(UploadModule.getFileSize(v[s])===undefined){q.onFileError(v[s],q.uploadErrors.can_not_get_size);continue}if(UploadModule.getFileSize(v[s])==0){q.onFileError(v[s],q.uploadErrors.can_not_upload_empty_file);continue}if(!UploadModule.checkSize(v[s],q)){q.onFileError(v[s],q.uploadErrors.file_too_large);continue}if(!UploadModule.checkSizeForCPUArch(v[s])){q.onFileError(v[s],q.uploadErrors.file_too_large_for_browser);continue}x.push(v[s])}var w=UploadModule.getFilesSize(x);c=c.concat(x);if(!a){n=w;g()}else{n+=w}};this.update=function(r){var t=r.parents("form:first");var s=r[0].files[0];s._updateKeepName=$("input[name=keepName]",t).val();s._updateFileId=$("input[name=updateFileId]",t).val();k.add(s)};this.cancelFile=function(r){if(!a){return}var s=h(r);if(!s){return}f(s)};this.cancel=function(){if(d){q.onFileCanceled(d);d._isCanceled=true}for(var r=0;r<c.length;r++){if(!c[r]._isUploaded){q.onFileCanceled(c[r]);c[r]._isCanceled=true}}j()};this.retry=function(r){if(d&&d._uiFileId==r){q.onFileRetry(d);UploadModule.getNewUploadUrl(d,function(s){if(s){o(d)}else{f(d,q.uploadErrors.dc_error)}})}};this.removeFromScratchRetry=function(r){};this.isUploadInProgress=function(){return a};return this};UploadModule.HandlerUploadResumable=function(d){var f=this;var g=d.url.replace("upload.jsp","upload5.jsp");var m=null;var j=null;var h=[];var b=[];var s=false;var c=0;var o=0;d=$.extend(true,{resumable:{section_size:500*1024,user_agents:"chrome,firefox"},onResumableFileConfirm:function(v,w){w({resumeUpload:true,all:true})}},d);function n(w){if(m&&m._uiFileId==w){return m}for(var v in h){if(h[v]._uiFileId==w){return h[v]}}}function e(x){if(!x._fileId&&!x._updateFileId){v(x)}else{w(x)}function v(y){$.ajax({type:"post",url:"/rest/sharedFileUpload/create?dirId="+y._uploadDir+"&name="+encodeURIComponent(y.fileName?y.fileName:y.name)+"&size="+y.size,success:function(A){if(!A.status){var z=d.uploadErrors.dc_error;if(A.message){z=$.extend(true,{},d.uploadErrors.dc_error);if(A.statusCode==403){z=$.extend(true,{},d.uploadErrors.user_not_verified)}z.message=A.message}u(y,z);return}y._url=A.url;y._fileId=A.fileId;y._d1link=A.d1link;y._previewLink=A.previewUrl;w(y)},error:function(){u(y,d.uploadErrors.dc_error)}})}function w(y){if(y!=m){return}var A=B(y);if(!A.length){m._isUploaded=true;c+=UploadModule.getFileSize(y);u(m)}else{z(y,A)}function B(E){var D=E._updateFileId?E.size:d.resumable.section_size;var I=null;var G=0;if(!E._sections||!E._sections.length){E._sections=[];I=0}else{var F=E._sections[0];if(F.start>0){I=0;G=F.start}else{for(var C=1;C<E._sections.length;C++){if(F.start+F.length<E._sections[C].start){I=F.start+F.length;G=E._sections[C].start-(F.start+F.length);break}F=E._sections[C]}}if(I==null){I=F.start+F.length}}if(!G){G=Math.min(E.size-I,D)}else{G=Math.min(G,D)}var H={start:I,length:G};E._sections.push(H);return H}function z(E,F){j=new XMLHttpRequest();j._currentFile=E;j._currentLoaded=0;j.upload.onprogress=function(J){if(!j){return}if(!J.lengthComputable){return}E._loaded+=J.loaded-j._currentLoaded;j._currentLoaded=J.loaded;var I={fileId:E._fileId,id:E._uiFileId,fileLoaded:E._loaded,fileSize:E.size,loaded:c+E._loaded,total:o,file:E};d.onProgress(I)};j.onreadystatechange=function(L){if(!j){return}if(!s||E._isUploaded||E._isCanceled){return}if(j.readyState==4){var K=false;if(j.status==200){var I=null;try{I=$.parseJSON(j.responseText)}catch(J){}if(I&&I.status=="OK"){w(E)}else{K=true}}else{K=true}if(K){H(L)}}};function H(L){if(!s||E._isUploaded){return}var J=null;if(j.status==0){J=d.uploadErrors.connection_error}else{if(j.responseText){var I=null;try{I=$.parseJSON(j.responseText)}catch(L){}if(I){var K=I.errorCode;if(K){J=d.getErrorByErrorCode(K)}}}}if(!J){J=d.uploadErrors.dc_error}u(E,J)}if(E._newDcPath){d.dc_path=E._newDcPath}var G=d.dc_path+g+(g.indexOf("?")==-1?"?":"&")+"sendHttpStatus=true"+UploadModule.getAuthInfo();var D=E._updateKeepName;var C=E._updateFileId;E._blobToSend=E.slice(F.start,F.length);j.open("POST",G+(C?("&updateFileId="+C+"&keepName="+D):"&resumableFileId="+E._fileId+"&resumableFirstByte="+F.start+"&sectionSize="+F.length),true);if(E._uploadDir){j.setRequestHeader("x-upload-dir",E._uploadDir)}j.setRequestHeader("x-file-name",encodeURIComponent(E.fileName?E.fileName:E.name));j.setRequestHeader("Content-Type","application/octet-stream");j.send(E._blobToSend)}}}function t(w){if(m&&m.name==w.name&&w.size==m.size){return true}for(var v=0;v<h.length;v++){if(h[v].name==w.name&&w.size==h[v].size){return true}}return false}function a(w){for(var v=0;v<w.length;v++){d.onFileError(w[v],d.uploadErrors.main_server_error);b.push(w[v])}if(!s){d.onCleanup()}}function q(x,z){var v=y(x);if(!v.length){return z()}w(v,z);function w(C,D){var A=B(C);$.ajax({type:"post",url:"/rest/sharedFileUpload/checkExist",contentType:"application/json;",data:JSON.stringify(A),success:function(F){for(var G in F){if(F[G]){for(var E=0;E<x.length;E++){if(G==x[E]._uiFileId){d.onFileCanceled(x[E]);x.splice(E,1);break}}}}D()},error:function(){a(x)}});function B(G){var E=[];for(var F=0;F<G.length;F++){E.push({uploadDirId:G[F]._uploadDir,fileName:UploadModule.getFileName(G[F]),fileSize:UploadModule.getFileSize(G[F]),uiId:G[F]._uiFileId})}return E}}function y(C){var B=[];for(var A=0;A<C.length;A++){if(C[A]._skipExisting){B.push(C[A])}}return B}}function k(z,w,C){if(w.forceNew){C()}else{var A=Utils.getFilesAndFolderIds(z).folderIdsArr;$.ajax({type:"post",url:"/rest/sharedFileUpload/status",contentType:"application/json; charset=utf-8",data:JSON.stringify(A),success:function(D){y(D,z,[])},error:function(D){console.log(D);a(z)}})}function x(D,E){return D.name==E.name&&D.size==E.size&&(!D._fileId||D._fileId==E.id)}function B(E,F){for(var D in F){if(x(E,F[D])){if(F[D].sections&&F[D].sections[0]){return true}}}}function v(F,G){for(var D in G){if(x(F,G[D])){F._url=G[D].url;F._fileId=G[D].id;F._d1link=G[D].d1link;F._previewLink=G[D].previewUrl;F._uploadDir=G[D].uploadDir;F._sections=[];var H=G[D].sections;for(var E in H){F._sections.push({start:parseInt(E),length:H[E]});F._loaded+=H[E]}break}}}function y(G,F,E){if(F.length){var D=F.pop();if(t(D)){if(!w.forceResume){E.push(D)}else{d.onFileCanceled(D)}y(G,F,E);return}if(w.forceNew||!B(D,G)){E.push(D);y(G,F,E)}else{if(w.forceResume){v(D,G);E.push(D);y(G,F,E)}else{d.onResumableFileConfirm(D,function(H){if(H){E.push(D);if(H.resumeUpload){v(D,G);if(H.all){w.forceResume=true}}else{if(H.all){w.forceNew=true}}}else{d.onFileCanceled(D)}y(G,F,E)})}}}else{while(E.length){z.push(E.pop())}C()}}}function l(){s=true;d.onStart();c=0;p()}function p(){if(!h.length){r()}else{m=h.shift();UploadModule.currentUploadSessionInfo.addToTotalAndValidateFreeSpace(m,function(){e(m)},function(v){u(m,v)})}}function u(x,v){v=UploadModule.skipRetryIfNeed(x,v,d);for(var w=0;w<h.length;w++){if(h[w]==x){h.splice(w,1)}}if(v){if(v.errorId==d.uploadErrors.can_not_upload_empty_file.errorId&&x.size){v=d.uploadErrors.file_was_removed}d.onFileError(x,v)}if(!x._isUploaded){x._sections=[];x._loaded=0;if(!v||!v.needRetry){o-=UploadModule.getFileSize(x);UploadModule.currentUploadSessionInfo.subtractFromTotal(x);if(v&&v.canRecover){b.push(x)}}if(!v){d.onFileCanceled(x);x._isCanceled=true}}else{d.onProgress({id:x._uiFileId,fileLoaded:UploadModule.getFileSize(x),fileSize:UploadModule.getFileSize(x),loaded:c,total:o});d.onFileUploaded(x)}if(x==m){if(j&&j._currentFile&&j._currentFile==x){j.abort();j=null}if(!v||!v.needRetry){p()}}}function r(){s=false;if(j){j.abort()}j=null;m=null;h=[];o=0;c=0;d.onCleanup()}this.start=function(){};this.update=function(v){var x=v.parents("form:first");var w=v[0].files[0];w._updateKeepName=$("input[name=keepName]",x).val();w._updateFileId=w._fileId=$("input[name=updateFileId]",x).val();f.add(w,v,{forceNew:true})};this.add=function(z,w,y){y=$.extend({forceResume:false,forceNew:false,checkFolderExists:true,isScratchRetry:false},y);var B=Utils.convertToPlainArray(z);Utils.clearInput(w);var v=UploadModule.parseFolderHierarchy(B);if(v.length){UploadModule.createFolderHierarchy({currentFolder:UploadModule.getCurrentDirIdForUpload(),hierarchy:v,files:B,successCallback:function(){f.add(B,w,y)},errorCallback:d.onFoldersCreationError,onFoldersCreated:d.onFoldersCreated,checkFolderExists:y.checkFolderExists});return}B=UploadModule.removeFoldersByDotInName(B);B=UploadModule.assignUIID(B);B=UploadModule.assignUploadDir(B,(y!==undefined&&y.toDirId!==undefined)?y.toDirId:d.toDirId);d.onAddFiles(B);if(!B.length){return}var A=B;B=[];for(var x=0;x<A.length;x++){if(d.required_extensions&&d.required_extensions.length&&$.inArray(Utils.extractExtension(A[x].name),d.required_extensions)==-1){d.onFileError(A[x],d.uploadErrors.wrong_file_type);continue}if(UploadModule.getFileSize(A[x])===undefined){d.onFileError(A[x],d.uploadErrors.can_not_get_size);continue}if(UploadModule.getFileSize(A[x])==0){d.onFileError(A[x],d.uploadErrors.can_not_upload_empty_file);continue}if(!UploadModule.checkSize(A[x],d)){d.onFileError(A[x],d.uploadErrors.file_too_large);continue}B.push(A[x])}q(B,function(){k(B,y,function(){o+=UploadModule.getFilesSize(B);h=h.concat(B);if(!s){l()}})})};this.cancelFile=function(v){if(!s){return}var w=n(v);if(!w){return}u(w)};this.cancel=function(){if(m){d.onFileCanceled(m);m._isCanceled=true}for(var v=0;v<h.length;v++){if(!h[v]._isUploaded){d.onFileCanceled(h[v]);h[v]._isCanceled=true}}r()};this.removeFromScratchRetry=function(v){for(var w=0;w<b.length;w++){if(b[w]._uiFileId==v){b.splice(w,1);break}}};this.retry=function(w){if(m&&m._uiFileId==w){d.onFileRetry(m);UploadModule.getNewUploadUrl(m,function(y){if(y){e(m)}else{u(m,d.uploadErrors.dc_error)}})}else{var v=null;for(var x=0;x<b.length;x++){if(b[x]._uiFileId==w){v=b[x];b.splice(x,1);break}}if(v){f.add(v)}}};this.checkFile=function(v){return t(v)};this.isUploadInProgress=function(){return s};return this};UploadModule.getUploadHandler=function(a){$.browser.chrome=/chrome/.test(navigator.userAgent.toLowerCase());if($.browser.chrome){$.browser.safari=false}if($.browser.opera){return UploadModule.HandlerUploadForm}if($.browser.safari){var b=navigator.userAgent.toLowerCase();b=b.substring(b.indexOf("version/")+8);b=b.split(" ")[0];b=b.substring(0,b.indexOf("."));$.browser.version=b;if($.browser.version<5){return UploadModule.HandlerUploadForm}}if(!!("multiple" in document.createElement("input"))&&UploadModule.FileSupported()&&UploadModule.XhrUploadSupported()){File.prototype.slice=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice;if(File.prototype.slice){File.prototype.slice=UploadModule.blobSliceCrossBrowserFixDecorator(File.prototype.slice)}if(File.prototype.slice&&(($.browser.mozilla&&a.resumable.user_agents.indexOf("firefox")>=0)||($.browser.chrome&&a.resumable.user_agents.indexOf("chrome")>=0))){return UploadModule.HandlerUploadResumable}else{return UploadModule.HandlerUploadXhr}}else{return UploadModule.HandlerUploadForm}};UploadModule.blobSliceCrossBrowserFixDecorator=function(a){return function(){var d=arguments[0];var b=arguments[1];var c=a.call(this,d,d+b);if(!c.size){if(this.size&&d<this.size&&b>0){c=a.apply(this,arguments)}}return c}};UploadModule.getAnonUploadHandler=function(){$.browser.chrome=/chrome/.test(navigator.userAgent.toLowerCase());if($.browser.chrome){$.browser.safari=false}if($.browser.opera){return UploadModule.HandlerUploadForm}if($.browser.safari){var a=navigator.userAgent.toLowerCase();a=a.substring(a.indexOf("version/")+8);a=a.split(" ")[0];a=a.substring(0,a.indexOf("."));$.browser.version=a;if($.browser.version<5){return UploadModule.HandlerUploadForm}}if(!!("multiple" in document.createElement("input"))&&UploadModule.FileSupported()&&UploadModule.XhrUploadSupported()){return UploadModule.HandlerUploadXhr}else{return UploadModule.HandlerUploadForm}};function UploadSessionInfo(b){var d=0;var a=0;function c(g,e,f){if(!d){var h=g._uploadDir;if(!h){d=10*1024*1024*1024;e();return}h=h?h:-1;$.ajax({type:"get",url:"/rest/account/freeSpace?dirId="+h,success:function(j){d=j.freeSpace;e()},error:function(){f(b.uploadErrors.dc_error)}})}else{e()}}this.addToTotalAndValidateFreeSpace=function(e,g,f){a+=UploadModule.getFileSize(e);c(e,function(){if(d-a>=0){g()}else{f(b.uploadErrors.not_enough_free_space)}},function(h){f(h)})};this.subtractFromTotal=function(e){a-=UploadModule.getFileSize(e);a=a>0?a:0}}function UploadModule(d){var c=this;d.onCleanup=b(d.onCleanup);d.onFileError=a(d.onFileError);d=$.extend(true,{upload_form:null,url:"/main/upload.jsp",progress_meter_url:null,max_file_size:0,required_extensions:null,check_close:true,retryCount:1000,uploadedFiles:[],upload_form_handler:{file_size_url:"/rest/file/size",progress_meter_comet:"/servlet/ProgressStatus2",progress_meter_json:"/rest/file/progress"},onStart:function(){},onProgress:function(g){},onError:function(g){},onComplete:function(){},onConfirm:function(g){return true},onCleanup:function(){},onFoldersCreated:function(){},onAddFiles:function(g){},onFileUploaded:function(g){},onFileCanceled:function(g){},onFileError:function(h,g){},onFileRetry:function(g){},i18n:{file_size_exceeded:"",some_files_size_exceeded:"",no_files_selected:"No files selected",resume_upload:"Some files are in incomplete state. Continue upload ?",your_browser_not_supported:"Your browser does not support the upload of large files",you_can_resume_upload:"Your transfer have been canceled. You can resume the upload with the current percentage",you_cannot_upload:"You cannot upload these files with current browser. Please try desktop version.",you_cannot_upload_flash:"Multiupload failed. Try uploading via 4shared Desktop.",want_change_dc:"The server is unavailable. Do you want to start upload to another server ? All uploaded data information will be lost.",not_enough_free_space:"Not Enough Free Space",can_not_upload_empty_file:"File is empty or can't be found.",dc_error:"Unknown server error",connection_error:"Connection problem",file_uploading_from_another_place:"File upload has already been resumed from another browser.",file_was_removed:"File is empty or can't be found.",can_not_get_size:"Not able to get size",incompleted_was_deleted:"File was removed from server.",wrong_file_type:"Wrong file type.",pending_upload_page_close:"Your upload may be incomplete if you leave this page.",upload_complete_message:"Your first upload to 4shared is a success.",user_not_verified:"User is not verified.",number_of_files_in_folder_limit:"Number of files in folder limit exceeded.",number_of_files_in_account_limit:"Number of files in account limit exceeded."}},d);d.i18n.file_size_exceeded=d.i18n.file_size_exceeded.replace(/\[maxFileSize\]/,Utils.readablizeBytes(d.max_file_size,true));d.uploadErrors={file_too_large:{errorId:1,canPremiumHelp:true,message:d.i18n.file_size_exceeded,serverErrCode:1},file_too_large_for_browser:{errorId:2,message:d.i18n.your_browser_not_supported},not_enough_free_space:{errorId:3,canPremiumHelp:true,message:d.i18n.not_enough_free_space,serverErrCode:2},can_not_upload_empty_file:{errorId:4,message:d.i18n.can_not_upload_empty_file,serverErrCode:3},file_uploading_from_another_place:{errorId:5,canRecover:true,message:d.i18n.file_uploading_from_another_place,serverErrCode:5},file_was_removed:{errorId:6,message:d.i18n.file_was_removed},incompleted_was_deleted:{errorId:7,message:d.i18n.incompleted_was_deleted,serverErrCode:6},dc_error:{errorId:8,canRecover:true,needRetry:true,message:d.i18n.dc_error,serverErrCode:4},main_server_error:{errorId:9,canRecover:true,message:d.i18n.dc_error},can_not_get_size:{errorId:10,message:d.i18n.can_not_get_size},flash_error:{errorId:11,message:d.i18n.you_cannot_upload_flash},connection_error:{errorId:12,canRecover:true,needRetry:true,message:d.i18n.connection_error},connection_error_scratch:{errorId:13,canRecover:true,message:d.i18n.connection_error},connection_error_norecover:{errorId:14,message:d.i18n.connection_error},wrong_file_type:{errorId:15,message:d.i18n.wrong_file_type,serverErrCode:7},user_not_verified:{errorId:16,needRetry:false,message:d.i18n.user_not_verified},number_of_files_in_folder_limit:{errorId:17,message:d.i18n.number_of_files_in_folder_limit,serverErrCode:102},number_of_files_in_account_limit:{errorId:18,message:d.i18n.number_of_files_in_account_limit,serverErrCode:103}};d.getErrorByErrorCode=function(g){for(i in d.uploadErrors){if(d.uploadErrors[i].serverErrCode==g){return d.uploadErrors[i]}}};var e=(d.uploadHandler)?new d.uploadHandler(d):new (UploadModule.getUploadHandler(d))(d);var f=null;UploadModule.currentUploadSessionInfo=new UploadSessionInfo(d);if(!($.browser.msie&&$.browser.version<9)&&d.check_close){$(window).bind("beforeunload unload",function(){if(c.isUploadInProgress()){return d.i18n.pending_upload_page_close}})}function b(g){return function(){if(!c.isUploadInProgress()){UploadModule.currentUploadSessionInfo=new UploadSessionInfo(d);g.apply(this,arguments)}favicon.remove(favicon.icons.uploadIcon)}}function a(g){return function(){if(Utils.isUnload()){return}var k=arguments[0];var j=arguments[1];var h=j.errorId;var l=[d.uploadErrors.dc_error.errorId,d.uploadErrors.main_server_error.errorId,d.uploadErrors.flash_error.errorId];if($.inArray(h,l)!=-1){Utils.checkConnectionAvaliable(function(m){if(m){g(k,j)}else{if(!j.canRecover){g(k,d.uploadErrors.connection_error_norecover);return}switch(h){case d.uploadErrors.dc_error.errorId:g(k,d.uploadErrors.connection_error);break;case d.uploadErrors.main_server_error.errorId:g(k,d.uploadErrors.connection_error_scratch);break;default:break}}},true)}else{g(k,j)}}}this.isUploadInProgress=function(){return e.isUploadInProgress()||(f&&f.isUploadInProgress())};this.start=function(){e.start()};this.add=function(j,g,h){e.add(j,g,h)};this.update=function(g){e.update(g)};this.cancel=function(){if(f&&f.isUploadInProgress()){f.cancel()}if(e.isUploadInProgress()){e.cancel()}};this.cancelFile=function(g){e.cancelFile(g);if(f){f.cancelFile(g)}};this.initFlash=function(){if(!f){f=new UploadModule.HandlerUploadFlash(d)}};this.retry=function(g){if(f){f.retry(g)}e.retry(g)};this.removeFromScratchRetry=function(g){e.removeFromScratchRetry(g)};this.checkFile=function(g){return e.checkFile(g)};this.canResumeUpload=function(){return e.constructor==UploadModule.HandlerUploadResumable};return this};