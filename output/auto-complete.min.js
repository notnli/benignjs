var autoComplete=function(){function n(n){function r(n,t){return n.classList?n.classList.contains(t):new RegExp("\\b"+t+"\\b").test(n.className)}function f(n,t,i){n.attachEvent?n.attachEvent("on"+t,i):n.addEventListener(t,i)}function o(n,t,i){n.detachEvent?n.detachEvent("on"+t,i):n.removeEventListener(t,i)}function e(n,t,i,u){f(u||document,t,function(t){for(var f,u=t.target||t.srcElement;u&&!(f=r(u,n));)u=u.parentElement;f&&i.call(u,t)})}var u,i,s,c,t,y,l;if(document.querySelector){u=this;u.shortcutMode=!1;i={selector:0,source:0,minChars:3,delay:150,cache:1,menuClass:"",cacheMax:3e3,minSuggestionsBoxSize:250,shortcutChar:":",renderItem:function(n,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var i=new RegExp("("+t.split(" ").join("|")+")","gi");return'<div class="autocomplete-suggestion" data-val="'+n+'">'+n.replace(i,"<b>$1<\/b>")+"<\/div>"},filterItems:function(n){return n},onSelect:function(){}};for(s in n)n.hasOwnProperty(s)&&(i[s]=n[s]);var a="",v="",h=typeof i.selector=="object"?[i.selector]:document.querySelectorAll(i.selector);for(c=0;c<h.length;c++)t=h[c],t.sc=document.createElement("div"),t.sc.className="autocomplete-suggestions "+i.menuClass,t.autocompleteAttr=t.getAttribute("autocomplete"),t.setAttribute("autocomplete","off"),t.cache=[],t.searches=[],t.last_val="",enterUseSuggestion=!1,t.updateSC=function(n,r){var u=t.getBoundingClientRect(),e,f;t.sc.style.left=u.left+(window.pageXOffset||document.documentElement.scrollLeft)+"px";t.sc.style.top=u.bottom+(window.pageYOffset||document.documentElement.scrollTop)+1+"px";t.sc.style.width=u.right-u.left>=i.minSuggestionsBoxSize?u.right-u.left+"px":i.minSuggestionsBoxSize+"px";!n&&t.sc.querySelector(".autocomplete-suggestion")&&(t.sc.style.display="block",t.sc.maxHeight||(t.sc.maxHeight=parseInt((window.getComputedStyle?getComputedStyle(t.sc,null):t.sc.currentStyle).maxHeight)),t.sc.suggestionHeight||(t.sc.suggestionHeight=t.sc.querySelector(".autocomplete-suggestion").offsetHeight),t.sc.suggestionHeight&&(r?(e=t.sc.scrollTop,f=r.getBoundingClientRect().top-t.sc.getBoundingClientRect().top,f+t.sc.suggestionHeight-t.sc.maxHeight>0?t.sc.scrollTop=f+t.sc.suggestionHeight+e-t.sc.maxHeight:f<0&&(t.sc.scrollTop=f+e)):t.sc.scrollTop=0))},f(window,"resize",t.updateSC),document.body.appendChild(t.sc),e("autocomplete-suggestion","mouseleave",function(){var n=t.sc.querySelector(".autocomplete-suggestion.hover");n&&setTimeout(function(){n.className=n.className.replace("hover","")},20);enterUseSuggestion=!1},t.sc),e("autocomplete-suggestion","mouseover",function(){var n=t.sc.querySelector(".autocomplete-suggestion.hover");n&&(n.className=n.className.replace("hover",""));this.className+=" hover";n=t.sc.querySelector(".autocomplete-footer.hover");n&&(n.className=n.className.replace(" hover",""));enterUseSuggestion=!1},t.sc),e("autocomplete-suggestion","mousedown",function(n){if(r(this,"autocomplete-suggestion")){var u=this.getAttribute("data-val"),f=this.getAttribute("data-dict"),e=JSON.parse(decodeURIComponent(u));i.onSelect(n,u,this);t.value="";t.last_val="";document.getElementById(i.selector.substr(1)).classList.remove("dict");f&&setTimeout(function(){document.getElementById("fSelect").classList.add("shake");setTimeout(function(){document.getElementById("fSelect").classList.remove("shake")},200)},20);setTimeout(function(){t.sc.style.display="none";document.getElementById(i.selector.substr(1)).focus()},250)}},t.sc),e("actips","mousedown",function(n){if(r(this,"actips")){var u=this.getAttribute("data-val");i.onSelect(n,u,this);setTimeout(function(){t.sc.style.display="none"},250)}},t.sc),e("autocomplete-footer","mousedown",function(n){if(r(this,"autocomplete-footer")){var u=this.getAttribute("data-val");i.onSelect(n,u,this);setTimeout(function(){t.sc.style.display="none"},250)}},t.sc),e("autocomplete-footer","mouseover",function(){var n=t.sc.querySelector(".autocomplete-suggestion.hover");n&&(n.className=n.className.replace(" hover",""));this.className+=" hover";enterUseSuggestion=!1},t.sc),t.blurHandler=function(){var r=document.querySelector(".autocomplete-suggestions.hover"),u=document.querySelector(".autocomplete-footer.hover"),n=document.getElementById("kbd_mka");r||u||n&&n.style!=="none"?t!==document.activeElement&&setTimeout(function(){document.activeElement.id!="fSelect"&&t.focus()},20):(t.value.slice(0,1)==i.shortcutChar?t.value=t.last_val:t.last_val=t.value,t.sc.style.display="none",setTimeout(function(){t.sc.style.display="none"},350))},f(t,"blur",t.blurHandler),y=function(n){var r=t.cache,u=[],i;if(n.length>0){for(i=0;i<r.length;i++)typeof r[i].ls=="undefined"&&u.push(r[i]);t.cache=u}else if(n.length==0){for(i=0;i<r.length;i++)typeof r[i].ls==1&&u.push(r[i]);t.cache=u;t.searches=[]}},l=function(n){var o=t.value,s,r,h,f,e;for(t.cache.length>=t.cacheMax&&(t.cache=[]),s=n.length,r=0;r<s;r++)h=u.shortcutMode?t.cache.some(function(t){return t.name==n[r].name&&t.dict==n[r].dict}):t.cache.some(function(t){return t.term==n[r].term&&t.language==n[r].language&&t.pinyn==n[r].pinyn&&t.transcription==n[r].transcription}),h||t.cache.push(n[r]);if(n.length&&o.length>=i.minChars){for(n=i.filterItems(n,o),f=a,e=0;e<n.length;e++)f+=i.renderItem(n[e],o);f+=v;t.sc.innerHTML=f;t.updateSC(0)}else t.sc.style.display="none"},t.keydownHandler=function(n){var o=window.event?n.keyCode:n.which,f,h,c,e,s;if(o==38&&n.preventDefault(),(o==40||o==38)&&t.sc.innerHTML&&(t.sc.style.display!="none"||t.value.length>0))return e=t.sc.querySelector(".autocomplete-suggestion.hover"),s=t.sc.querySelector(".autocomplete-footer.hover"),e?(f=o==40?e.nextSibling:e.previousSibling,f?(e.className=e.className.replace("hover",""),f.className+=" hover",h=r(f,"autocomplete-footer"),c=r(f,"autocomplete-header"),h||c||!f.hasAttribute("data-val")||f.hasAttribute("data-dict")?!h&&!c&&f.hasAttribute("data-val")&&f.hasAttribute("data-dict")?t.value=i.shortcutChar+JSON.parse(decodeURIComponent(f.getAttribute("data-val"))).name:(t.value=t.last_val,f=0):t.value=JSON.parse(decodeURIComponent(f.getAttribute("data-val"))).term):(e.className=e.className.replace("hover",""),t.value=t.last_val,f=0)):(s?(f=o==40?t.sc.querySelector(".autocomplete-suggestion"):s.previousSibling,s.className=s.className.replace("hover","")):f=o==40?t.sc.querySelector(".autocomplete-suggestion"):t.sc.childNodes[t.sc.childNodes.length-1],f.className+=" hover",h=r(f,"autocomplete-footer"),c=r(f,"autocomplete-header"),h||c||!f.hasAttribute("data-val")||f.hasAttribute("data-dict")?!h&&!c&&f.hasAttribute("data-val")&&f.hasAttribute("data-dict")?t.value=i.shortcutChar+JSON.parse(decodeURIComponent(f.getAttribute("data-val"))).name:(t.value=t.last_val,f=0):t.value=JSON.parse(decodeURIComponent(f.getAttribute("data-val"))).term),enterUseSuggestion=!0,t.updateSC(0,f),!1;if(o==27)t.value=t.last_val,t.sc.style.display="none",enterUseSuggestion=!1;else if((o==13||o==9)&&enterUseSuggestion===!0){if(e=t.sc.querySelector(".autocomplete-suggestion.hover"),s=t.sc.querySelector(".autocomplete-footer.hover"),s&&(e=s),e&&t.sc.style.display!="none"){n.preventDefault();e.hasAttribute("data-dict")&&(t.last_val="");i.onSelect(n,e.getAttribute("data-val"),e);setTimeout(function(){t.sc.style.display="none";enterUseSuggestion=!1;document.getElementById("fSelect").classList.add("shake");setTimeout(function(){document.getElementById("fSelect").classList.remove("shake")},200)},20)}}else if((o==13||o==9||o==32)&&u.shortcutMode&&(n.preventDefault(),!t.sc.querySelector(".autocomplete-suggestion.hover"))){let r=t.value.slice(1,t.value.length).trim(),u=t.cache.find(function(n){return n.dict&&n.dict==r||n.name&&deaccent(n.name.toLowerCase())==deaccent(r.toLowerCase())});if(u){i.onSelect(n,JSON.stringify(u),this);setTimeout(function(){t.sc.style.display="none";enterUseSuggestion=!1;document.getElementById("fSelect").classList.add("shake");setTimeout(function(){document.getElementById("fSelect").classList.remove("shake")},200)},20)}else if(o==9&&t.sc.querySelector(".autocomplete-suggestion[data-dict]")){let n=t.sc.querySelector(".autocomplete-suggestion[data-dict]");if(n){var l=n.getAttribute("data-val"),v=this.getAttribute("data-dict"),a=JSON.parse(decodeURIComponent(l));n.classList.add("hover");t.value=i.shortcutChar+a.name}}}},f(t,"keydown",t.keydownHandler),t.keyupHandler=function(n){var f,r,h,c,s,e,o;if(u.shortcutMode=t.value.length>0&&t.value.slice(0,1)==i.shortcutChar,y(t.value),f=window.event?n.keyCode:n.which,u.shortcutMode?(document.getElementById(i.selector.substr(1)).classList.add("dict"),t.last_val.length>0&&t.last_val.slice(0,1)!=i.shortcutChar&&(t.last_val="",t.searches=[])):document.getElementById(i.selector.substr(1)).classList.remove("dict"),!f||(f<35||f>40)&&f!=13&&f!=27)if(r=deaccent(t.value),val=u.shortcutMode?r.slice(1,r.length):r,r.length>=i.minChars){if(r!=t.last_val){if(h=t.last_val,t.last_val=r,clearTimeout(t.timer),i.cache==!0&&(c=t.searches.some(function(n){return r.indexOf(n)>-1}),c==!0&&(h.length<val.length||t.cache.some(function(n){return n.term&&n.term.indexOf(val)>-1||n.pinyn&&n.pinyn.indexOf(val)>-1||n.dict&&n.dict.indexOf(val)>-1||n.name&&n.name.indexOf(val)>-1}))&&(s=[],f==32||f==189||f==109?(e=val.substr(0,val.length-1),s=t.cache.filter(function(n){return n.term&&deaccent(n.term).indexOf(e+" ")==0||n.term&&deaccent(n.term).indexOf(e+"-")==0||n.pinyn&&(deaccent(n.pinyn).indexOf(e+" ")==0||deaccent(n.pinyn).indexOf(e+"-")==0)||n.dict&&deaccent(n.dict).indexOf(e+"-")==0||n.name&&deaccent(n.name).indexOf(e+"-")==0})):(o=new RegExp("^"+val,"i"),s=t.cache.filter(function(n){return n.term&&o.test(deaccent(n.term))||n.pinyn&&o.test(deaccent(n.pinyn))||n.transcription&&o.test(deaccent(n.transcription))||n.dict&&o.test(deaccent(n.dict))||n.name&&o.test(deaccent(n.name))})),s.length>0))){l(s);return}t.timer=setTimeout(function(){var n=t.searches.some(function(n){return n===r});!n&&r.length>0&&t.searches.push(r);i.source(r,l)},i.delay)}}else t.last_val=r,t.sc.style.display="none"},f(t,"keyup",t.keyupHandler),t.clickHandler=function(n){t.last_val="\n";t.keyupHandler(n)},i.minChars||f(t,"click",t.clickHandler);this.setHeader=function(n){a=n};this.setFooter=function(n){v=n};this.destroy=function(){for(var n,t=0;t<h.length;t++)n=h[t],o(window,"resize",n.updateSC),o(n,"blur",n.blurHandler),o(n,"click",n.clickHandler),o(n,"keydown",n.keydownHandler),o(n,"keyup",n.keyupHandler),n.autocompleteAttr?n.setAttribute("autocomplete",n.autocompleteAttr):n.removeAttribute("autocomplete"),document.body.removeChild(n.sc),n=null}}}return n}();(function(){typeof define=="function"&&define.amd?define("autoComplete",function(){return autoComplete}):window.autoComplete=autoComplete})();